<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Tracker Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1 { text-align: center; color: #2c3e50; }
        .stats {
            display: flex; justify-content: center; gap: 20px; margin: 20px 0;
        }
        .stat-card {
            background: #fff; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center; min-width: 150px;
        }
        .filters {
            text-align: center; margin: 20px 0;
        }
        .filters select, .filters button {
            margin: 0 5px; padding: 5px;
        }
        canvas {
            max-width: 400px; margin: 20px auto; background: #fff;
            padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        table {
            margin: 20px auto; border-collapse: collapse; width: 80%;
            background: #fff;
        }
        table th, table td {
            border: 1px solid #ccc; padding: 8px 12px; text-align: left;
        }
        table th { background: #f4f4f4; }
        #loading {
            text-align: center; color: #555; display: none;
        }
        #cacheStatus {
            text-align: center; font-size: 14px; margin-top: -10px;
        }
        #cacheStatus.hit { color: green; }
        #cacheStatus.miss { color: red; }
    </style>
</head>
<body>
    <h1>DSA Tracker Dashboard</h1>
    <p style="text-align:right;"><a href="{{ url_for('logout') }}">Logout</a></p>

    <div id="cacheStatus">Cache: --</div>

    <!-- Stats -->
    <div class="stats">
        <div class="stat-card">
            <h2>Total Problems</h2>
            <p id="totalProblems">{{ total_problems }}</p>
        </div>
        <div class="stat-card">
            <h2>Current Streak</h2>
            <p id="streak">{{ streak }} days</p>
        </div>
    </div>

    <!-- Add Problem Form -->
    <div style="max-width: 600px; margin: 20px auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0;">Add New Problem</h3>
        <input type="text" id="title" placeholder="Title" style="width: 100%; padding: 8px; margin-bottom: 8px;">
        <input type="text" id="url" placeholder="URL" style="width: 100%; padding: 8px; margin-bottom: 8px;">
        <select id="difficulty" style="width: 100%; padding: 8px; margin-bottom: 8px;">
            <option value="">Select Difficulty</option>
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
        </select>
        <input type="text" id="topic" placeholder="Topic" style="width: 100%; padding: 8px; margin-bottom: 8px;">
        <label><input type="checkbox" id="solved"> Solved</label>
        <label style="margin-left:15px;"><input type="checkbox" id="needs_revision"> Needs Revision</label>
        <button onclick="addProblem()" style="margin-top: 10px; width: 100%; background: #36A2EB; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer;">Add Problem</button>
    </div>

    <!-- Filters -->
    <div class="filters">
        <label>Difficulty:</label>
        <select id="difficultyFilter">
            <option value="">All</option>
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
        </select>
        <label>Topic:</label>
        <select id="topicFilter">
            <option value="">All</option>
        </select>
        <button onclick="loadFilteredData()">Apply Filters</button>
    </div>

    <canvas id="difficultyChart"></canvas>
    <p id="loading">Loading data...</p>

    <!-- Recent Problems Table -->
    <h2 style="text-align:center;">Recent Problems</h2>
    <table>
        <thead>
            <tr>
                <th>Title</th>
                <th>Difficulty</th>
                <th>Topic</th>
                <th>Date Solved</th>
            </tr>
        </thead>
        <tbody id="problemsTableBody"></tbody>
    </table>

    <script>
        const chartData = {{ chart_data | tojson | safe }};
        const ctx = document.getElementById('difficultyChart').getContext('2d');
        let chartInstance = new Chart(ctx, {
            type: 'pie',
            data: chartData,
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Problems by Difficulty' }
                }
            }
        });

        async function loadFilteredData() {
            document.getElementById("loading").style.display = "block";
            const difficulty = document.getElementById("difficultyFilter").value;
            const topic = document.getElementById("topicFilter").value;

            let url = `/api/questions?`;
            if (difficulty) url += `difficulty=${encodeURIComponent(difficulty)}&`;
            if (topic) url += `topic=${encodeURIComponent(topic)}&`;

            try {
                const res = await fetch(url, {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
                });
                const result = await res.json();
                const questions = result.questions || [];

                // Show cache status
                const cacheStatus = document.getElementById("cacheStatus");
                if (result.cached === true) {
                    cacheStatus.textContent = "Cache: HIT";
                    cacheStatus.className = "hit";
                } else if (result.cached === false) {
                    cacheStatus.textContent = "Cache: MISS";
                    cacheStatus.className = "miss";
                } else {
                    cacheStatus.textContent = "Cache: --";
                    cacheStatus.className = "";
                }

                // Update chart
                const grouped = {};
                questions.forEach(q => {
                    grouped[q.difficulty] = (grouped[q.difficulty] || 0) + 1;
                });
                chartInstance.data.labels = Object.keys(grouped);
                chartInstance.data.datasets[0].data = Object.values(grouped);
                chartInstance.update();

                // Update table
                const tableBody = document.getElementById("problemsTableBody");
                tableBody.innerHTML = "";
                questions.forEach(q => {
                    tableBody.innerHTML += `
                        <tr>
                            <td>${q.title || q.url}</td>
                            <td>${q.difficulty}</td>
                            <td>${q.topic}</td>
                            <td>${q.date_solved || ''}</td>
                        </tr>
                    `;
                });

                // Update stats
                document.getElementById("totalProblems").textContent = questions.length;

                // Populate topic filter
                const topicFilter = document.getElementById("topicFilter");
                const topics = [...new Set(questions.map(q => q.topic).filter(Boolean))];
                topicFilter.innerHTML = `<option value="">All</option>` + topics.map(t => `<option value="${t}">${t}</option>`).join("");
            } catch (error) {
                alert("Error loading data: " + error);
            } finally {
                document.getElementById("loading").style.display = "none";
            }
        }

        async function addProblem() {
            const token = localStorage.getItem("token");
            if (!token) return alert("You must be logged in to add a problem.");

            const title = document.getElementById("title").value.trim();
            const url = document.getElementById("url").value.trim();
            const difficulty = document.getElementById("difficulty").value;
            const topic = document.getElementById("topic").value.trim();
            const solved = document.getElementById("solved").checked;
            const needs_revision = document.getElementById("needs_revision").checked;

            if (!url || !difficulty || !topic) return alert("Please fill in all required fields.");

            try {
                const res = await fetch("/api/questions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ title, url, difficulty, topic, solved, needs_revision })
                });

                if (res.ok) {
                    alert("Problem added successfully!");
                    document.getElementById("title").value = "";
                    document.getElementById("url").value = "";
                    document.getElementById("difficulty").value = "";
                    document.getElementById("topic").value = "";
                    document.getElementById("solved").checked = false;
                    document.getElementById("needs_revision").checked = false;
                    loadFilteredData();
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.error || "Failed to add problem"));
                }
            } catch (error) {
                alert("Error adding problem: " + error);
            }
        }

        window.onload = loadFilteredData;
    </script>
</body>
</html>
